<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Caption Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-glow: #00f2fe;
            --secondary-glow: #4facfe;
            --background-dark: #121212;
            --text-color: #e0e0e0;
            --glass-bg: rgba(20, 20, 40, 0.6);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #121212);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            text-align: center;
            padding: 50px;
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .nav-links { position: absolute; top: 20px; right: 30px; z-index: 10; }
        .nav-links a { color: var(--primary-glow); margin-left: 20px; text-decoration: none; font-weight: 600; transition: color 0.3s; }
        .nav-links a:hover { color: white; }
        
        h1 { color: white; margin-bottom: 30px; font-size: 2.5em; font-weight: 600; text-shadow: 0 0 10px var(--primary-glow), 0 0 20px var(--primary-glow), 0 0 40px rgba(0, 242, 254, 0.5); animation: fadeInDown 1s ease-out; }
        .upload-container { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 20px; padding: 40px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); width: 90%; max-width: 600px; animation: fadeInUp 1s ease-out; transition: all 0.3s ease; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #imageInput { display: none; }
        .custom-file-upload { border: 2px dashed var(--secondary-glow); border-radius: 10px; display: flex; justify-content: center; align-items: center; padding: 30px; margin: 15px 0; cursor: pointer; transition: background-color 0.3s, border-color 0.3s, opacity 0.5s; font-size: 1.1em; color: var(--secondary-glow); }
        .custom-file-upload:hover { background-color: rgba(79, 172, 254, 0.1); border-color: var(--primary-glow); }
        .preview { margin-top: 20px; }
        img { max-width: 100%; max-height: 300px; border-radius: 10px; display: none; border: 2px solid var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        button { background: transparent; color: white; border: 2px solid var(--secondary-glow); padding: 12px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        
        /* NEW: Style for the disabled button */
        button:disabled {
            background: #555;
            border-color: #777;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button[type="submit"] { background: var(--secondary-glow); box-shadow: 0 0 15px rgba(79, 172, 254, 0.5); }
        button[type="submit"]:hover:not(:disabled) { background: var(--primary-glow); border-color: var(--primary-glow); box-shadow: 0 0 25px var(--primary-glow); }
        button:hover:not(:disabled) { background: var(--secondary-glow); box-shadow: 0 0 20px var(--secondary-glow); }
        #resetButton { display: none; }
        
        .caption-box { 
            margin-top: 30px; 
            display: none;
            text-align: left;
        }
        
        .caption-card { background: rgba(0,0,0,0.25); border-radius: 10px; padding: 15px 20px; margin-bottom: 15px; animation: fadeIn 0.5s; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        .caption-text { flex-grow: 1; margin-right: 15px; font-size: 15px; line-height: 1.6; }
        .copy-btn { background: var(--secondary-glow); color: white; border: none; padding: 8px 15px; font-size: 14px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .copy-btn:hover { background: var(--primary-glow); box-shadow: 0 0 10px var(--primary-glow); }
        
        .style-selector { margin-top: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .style-selector label { font-weight: 600; color: var(--text-color); }
        .style-selector select { background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--secondary-glow); border-radius: 8px; padding: 8px 12px; font-family: 'Poppins', sans-serif; font-size: 15px; cursor: pointer; }
        .style-selector select:focus { outline: none; box-shadow: 0 0 10px var(--primary-glow); }

        .loader { display: flex; justify-content: center; align-items: center; height: 100%; }
        .loader div { width: 10px; height: 10px; background: var(--primary-glow); border-radius: 50%; margin: 0 5px; animation: pulse 1.4s infinite ease-in-out both; }
        .loader div:nth-child(1) { animation-delay: -0.32s; }
        .loader div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body>

<div class="nav-links">
    <a href="/history">History</a>
    <a href="/logout">Logout</a>
</div>

<div class="main-container">
    <h1>AI CAPTION GENERATOR</h1>
    <div class="upload-container">
        <form id="uploadForm">
            <label for="imageInput" class="custom-file-upload" id="uploadLabel">
                Click to Upload Image
            </label>
            <input type="file" id="imageInput" name="image" accept="image/*" required>
            <div class="preview">
                <img id="imagePreview" alt="Image Preview">
            </div>
            
            <div class="style-selector">
                <label for="captionStyle">Caption Style:</label>
                <select id="captionStyle" name="style">
                    <option value="Standard">Standard</option>
                    <option value="Funny">Funny</option>
                    <option value="Inspirational">Inspirational</option>
                    <option value="One Word">One Word</option>
                    <option value="As a Question">As a Question</option>
                </select>
            </div>

            <br>
            <div class="button-container">
                <!-- MODIFIED: Button is now disabled by default -->
                <button type="submit" id="generateButton" disabled>Generate Caption</button>
                <button type="button" id="resetButton">Upload New</button>
            </div>
        </form>

        <div class="caption-box" id="captionBox">
            <div id="captionContainer"></div>
        </div>
    </div>
</div>

<script>
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const uploadForm = document.getElementById("uploadForm");
    const captionBox = document.getElementById("captionBox");
    const captionContainer = document.getElementById("captionContainer");
    const uploadLabel = document.getElementById("uploadLabel");
    const resetButton = document.getElementById("resetButton");
    const generateButton = document.getElementById("generateButton"); // Get the generate button

    imageInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = "block";
                uploadLabel.style.display = "none";
                resetButton.style.display = "inline-block";
                generateButton.disabled = false; // Enable the button
            };
            reader.readAsDataURL(file);
        } else {
             generateButton.disabled = true; // Disable if no file is chosen
        }
    });

    uploadForm.addEventListener("submit", function (e) {
        e.preventDefault();
        
        // This client-side check is still good practice
        if (!imageInput.files || imageInput.files.length === 0) {
            console.log("No file selected.");
            return;
        }

        const formData = new FormData();
        formData.append("image", imageInput.files[0]);
        const captionStyle = document.getElementById("captionStyle").value;
        formData.append("style", captionStyle);
        
        captionContainer.innerHTML = '<div class="loader"><div></div><div></div><div></div></div>';
        captionBox.style.display = "block";

        fetch("/api/caption/generate", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (response.status === 401) {
                 window.location.href = '/login';
                 return;
            }
            return response.text();
        })
        .then(data => {
            if(!data) return;

            captionContainer.innerHTML = '';
            const captions = data.split('\n').map(line => line.replace(/^\s*\*\s*/, '')).filter(line => line.trim() !== '');

            if (captions.length === 0) {
                 captionContainer.innerHTML = '<div class="caption-card"><span class="caption-text">Could not generate a caption. Please try again.</span></div>';
                 return;
            }

            captions.forEach(captionText => {
                const card = document.createElement('div');
                card.className = 'caption-card';
                const cleanCaption = captionText.replace(/^"|"$/g, '');
                card.innerHTML = `
                    <span class="caption-text">${cleanCaption}</span>
                    <button class="copy-btn" onclick="copyCaption(this)">Copy</button>
                `;
                captionContainer.appendChild(card);
            });
        })
        .catch(error => {
            captionContainer.innerHTML = `<div class="caption-card"><span class="caption-text">Error: ${error}</span></div>`;
        });
    });
    
    function copyCaption(buttonElement) {
        const textToCopy = buttonElement.previousElementSibling.innerText;
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);

        buttonElement.textContent = "Copied!";
        buttonElement.style.background = "#00f2fe";
        setTimeout(() => {
            buttonElement.textContent = "Copy";
            buttonElement.style.background = "var(--secondary-glow)";
        }, 2000);
    }

    resetButton.addEventListener("click", function() {
        imageInput.value = null;
        imagePreview.style.display = "none";
        imagePreview.src = "";
        resetButton.style.display = "none";
        uploadLabel.style.display = "flex";
        captionBox.style.display = "none";
        captionContainer.innerHTML = "";
        generateButton.disabled = true; // Disable the button again
    });
</script>

</body>
</html>

